<html>
	<head>
		<script type="text/javascript" src="underscore-min.js"></script>
		<script type="text/javascript" src="geom.js"></script>
	</head>
	<body>
		<canvas id="canvas" width="500" height="500"></canvas>
		<script type="text/javascript">
			window.addEventListener('load', function () {
			
				var fps = 20;
				var now;
				var then = Date.now();
				var interval = 1000/fps;
				var delta;
			
				// http://www.html5canvastutorials.com/advanced/html5-canvas-animation-stage/
				window.requestAnimFrame = (function(callback) {
					return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
					function(callback) {
						window.setTimeout(callback, 1000 / 60
						);
					};
				})();
			
				function calcBeta(inclination) {
					return Math.abs(Math.deg2rad(90) - inclination);
				}
			
				/**
				* Inclination in rad
				* left array, with left contour
				* right array, with right contour
				*/
				function calcFat(linePoint, width, beta, left, right) {
					if (beta == 0 || beta == Math.PI) {
						// vertical
						var offsetX = width;
						var offsetY = 0;				
					} else if (beta == .5 * Math.PI || beta == 1.5 * Math.PI) {
						// horizontal
						var offsetX = 0;
						var offsetY = width;
					} else {
						// Angled
						var offsetX = Math.sin(beta) * width;
						var offsetY = Math.cos(beta) * width;
					}

					left.push(point(linePoint.x + (offsetX), linePoint.y - (offsetY)));
					right.push(point(linePoint.x - (offsetX), linePoint.y + (offsetY)));
				}
			
				function lineWidth(t, offset) {
					return 30 - Math.abs(Math.sin((t + offset) * Math.PI * 3)) * 40;
				}

				function drawPath(ctx, path) {
					var left = [];
					var right = [];
					
					for(var t=0;t<=1;t+=.001) {
						calcFat(path.at(t), lineWidth(t, 0), calcBeta(path.angle(t)), left, right);
					}
				
					ctx.beginPath();
					ctx.moveTo(left[0].x, left[0].y);
					
					for(var i=1;i < left.length; i++) {
						ctx.lineTo(left[i].x, left[i].y);
					}
					
	// 				ctx.fillStyle = fillcolor
					ctx.strokeStyle = "black";
					ctx.stroke();
				}
				
				var path = new Path([
					point(100,400),
					point(100,100),
					point(250,250),
					point(400,100),
					point(400,400)
				]);
				
				function drawFrame (offset) {
					now = Date.now();
					delta = now - then;
					
					if (delta > interval) {
						var canvas = document.getElementById("canvas");
						var ctx = canvas.getContext("2d");
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						drawPath(ctx, path);
					}
					
					requestAnimFrame(function() {
						drawFrame(offset);
					});
				}
				
				drawFrame(0);
			});
		</script>
	</body>
</html>